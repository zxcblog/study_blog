# 部署gitlab
1. 拉取并运行gitlab镜像
```shell
docker pull gitlab/gitlab-ce:latest
```
本次配置使用docker-compose配置启动服务， dockerfile文件请查看`gitlab.yaml`

2. 修改配置文件`./data/etc/gitlab.rb`, 添加以下配置
```text
external_url 'http://gitlab.local.com:9980'
gitlab_rails['gitlab_shell_ssh_port'] = 9922
```

3. 重载配置
```shell
docker exec -it gitlab /bin/bash

gitlab-ctl reconfigure
```

4. 使用 http://gitlab.local.com:9980 页面访问

5. 设置用户名密码
```shell
gitlab-rails console -e production

# 1. 使用默认账户进行登录
u = User.where(id:1).first 该命令会使用root进行创建
u.password='zxczxc_1234'
u.email='zxc_7310@163.com'
u.save!


# 2. 创建用户进行登录
u = User.new(username: 'zcx7310', email: 'zxc_7310@163.com', name: 'zcx7310', password: 'zxczxc_1234', password_confirmation: 'zxczxc_1234')
u.assign_personal_namespace(Organizations::Organization.default_organization)
u.skip_confirmation! # 跳过邮件验证
u.save!

exit
```

# 其他配置
> 配置文件为 `/etc/gitlab.rb`文件， 设置配置后都需要重加载配置文件 `gitlab-ctl reconfigure`
1. [邮箱配置](https://docs.gitlab.com/omnibus/settings/smtp.html)
网易邮箱配置， 其他配置请查看官方文档
```text
gitlab_rails['smtp_enable'] = true
gitlab_rails['smtp_address'] = "smtp.163.com"
gitlab_rails['smtp_port'] = 465
gitlab_rails['smtp_user_name'] = "zxc_7310@163.com"
gitlab_rails['smtp_password'] = "password"
gitlab_rails['smtp_authentication'] = "login"
gitlab_rails['smtp_enable_starttls_auto'] = false
gitlab_rails['smtp_tls'] = true
gitlab_rails['gitlab_email_from'] = 'zxc_7310@163.com'
gitlab_rails['smtp_domain'] = "smtp.163.com"


### Email Settings

gitlab_rails['gitlab_email_enabled'] = true

##! If your SMTP server does not like the default 'From: gitlab@gitlab.example.com'
##! can change the 'From' with this setting.
gitlab_rails['gitlab_email_from'] = 'zxc_7310@163.com'
gitlab_rails['gitlab_email_display_name'] = 'gitlab'
gitlab_rails['gitlab_email_reply_to'] = 'zxc_7310@163.com'
gitlab_rails['gitlab_email_subject_suffix'] = ''
gitlab_rails['gitlab_email_smime_enabled'] = false
gitlab_rails['gitlab_email_smime_key_file'] = '/etc/gitlab/ssl/gitlab_smime.key'
gitlab_rails['gitlab_email_smime_cert_file'] = '/etc/gitlab/ssl/gitlab_smime.crt'
gitlab_rails['gitlab_email_smime_ca_certs_file'] = '/etc/gitlab/ssl/gitlab_smime_cas.crt'
```
测试邮件发送
```shell
gitlab-rails console

Notify.test_email('zxc_7310@163.com', 'test email', 'this is a test email').deliver_now
```

